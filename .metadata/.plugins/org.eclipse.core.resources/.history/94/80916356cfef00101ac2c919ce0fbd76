package fr.insa.mas.Controller;

import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import org.springframework.web.client.RestTemplate;

@RestController
@SpringBootApplication
@RequestMapping("/Controller/")
public class ControllerApplication {

    private final DatabaseLogger databaseLogger = new DatabaseLogger();
    private static final Logger logger = LoggerFactory.getLogger(ControllerApplication.class);

    // === Microservices URLs (√† adapter selon votre archi) ===
    private final String MovDetectUrl     = "http://localhost:8082/MovementDetection/";
    private final String LightControlUrl  = "http://localhost:8081/LightControl/";
    private final String AlarmControlUrl  = "http://localhost:8083/AlarmControl/";

    // Sc√©nario 1 : voiture + barri√®re (NOUVEAU)
    // ‚ö†Ô∏è Remplace les ports/paths si tes microservices existent d√©j√† sous d‚Äôautres URLs.
    private final String CarDetectUrl     = "http://localhost:8084/CarDetection/";
    private final String BarrierControlUrl= "http://localhost:8085/BarrierControl/";

    // === Flags d‚Äôautomatisation ===
    private boolean autoEnergyLight = false;   // Sc√©nario 3
    private boolean autoSecurity    = false;   // Sc√©nario 2
    private boolean autoBarrier     = false;   // Sc√©nario 1

    // === Horaires de s√©curit√© (Sc√©nario 2) ===
    // Exemple : la s√©curit√© se d√©clenche hors 08:00 - 18:00
    private LocalTime securityStart = LocalTime.of(8, 0);
    private LocalTime securityEnd   = LocalTime.of(18, 0);

    private static final DateTimeFormatter DT = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

    // ============ Utils UI ============

    private String buildHtml(String title, String body, String bgColor, String cardColor, String titleColor) {
        return "<html>" +
                "<head>" +
                "<style>" +
                "body { font-family: Arial, sans-serif; background-color: " + bgColor + "; text-align: center; margin: 0; padding: 0; }" +
                ".container { padding: 18px; background-color: " + cardColor + "; border-radius: 16px; margin: 60px auto; max-width: 520px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }" +
                "h1 { color: " + titleColor + "; margin: 0; padding: 12px; border-radius: 12px; }" +
                "p { font-size: 16px; color: #EAEAEA; line-height: 1.5; }" +
                ".meta { font-size: 13px; color: #BDBDBD; margin-top: 12px; }" +
                "</style>" +
                "</head>" +
                "<body>" +
                "<div class='container'>" +
                "<h1>" + title + "</h1>" +
                "<p>" + body + "</p>" +
                "<div class='meta'>‚è±Ô∏è " + LocalDateTime.now().format(DT) + "</div>" +
                "</div>" +
                "</body>" +
                "</html>";
    }

    private RestTemplate rt() {
        return new RestTemplate();
    }

    private boolean isOutsideSecurityHours() {
        LocalTime now = LocalTime.now();
        // s√©curit√© active hors [securityStart, securityEnd]
        return now.isBefore(securityStart) || now.isAfter(securityEnd);
    }

    // ============ Logs ============

    @GetMapping("/logTest")
    public String logTest() {
        databaseLogger.logEvent("‚úÖ Test event from Controller project.");
        return "Event logged successfully!";
    }

    // =========================================================
    // SC√âNARIO 3 ‚Äî √ânergie : mouvement -> contr√¥le √©clairage
    // =========================================================

    @GetMapping("isAutoEnergyLightActivated/")
    public ResponseEntity<String> isAutoEnergyLightActivated() {
        String title = "√ânergie - Lumi√®res automatiques " + (autoEnergyLight ? "‚úÖüí°" : "‚ùåüî¶");
        String body  = autoEnergyLight
                ? "Le mode √©conomie d‚Äô√©nergie est activ√© : les lumi√®res s‚Äôallument/ s‚Äô√©teignent selon la pr√©sence."
                : "Le mode √©conomie d‚Äô√©nergie est d√©sactiv√© : les lumi√®res ne sont pas contr√¥l√©es automatiquement.";

        logger.info(title);
        return new ResponseEntity<>(buildHtml(title, body, "#0B3D2E", "#0F172A", "#A7F3D0"), HttpStatus.OK);
    }

    @GetMapping("setAutoEnergyLight/")
    public ResponseEntity<String> setAutoEnergyLight(@RequestParam boolean enabled) {
        autoEnergyLight = enabled;

        String title = "√ânergie - Mise √† jour " + (enabled ? "‚úÖüí°" : "‚ùåüåë");
        String body  = enabled
                ? "Mode √©conomie d‚Äô√©nergie activ√© : √©clairage pilot√© automatiquement via d√©tection de mouvement."
                : "Mode √©conomie d‚Äô√©nergie d√©sactiv√© : √©clairage en mode manuel.";

        databaseLogger.logEvent("üí° AutoEnergyLight = " + enabled);
        logger.info(title);
        return new ResponseEntity<>(buildHtml(title, body, "#0B3D2E", "#0F172A", "#A7F3D0"), HttpStatus.OK);
    }

    public void runAutoEnergyLight() {
        String url_getDetection = MovDetectUrl + "getDetection/";
        String url_setLightOn   = LightControlUrl + "setON/?oN=true";
        String url_setLightOff  = LightControlUrl + "setON/?oN=false";

        boolean movement = rt().getForObject(url_getDetection, boolean.class);

        if (movement) {
            rt().getForObject(url_setLightOn, Boolean.class);
            databaseLogger.logEvent("üí° Lumi√®res ON (mouvement d√©tect√©).");
        } else {
            rt().getForObject(url_setLightOff, Boolean.class);
            databaseLogger.logEvent("üåô Lumi√®res OFF (aucun mouvement).");
        }
    }

    // =========================================================
    // SC√âNARIO 2 ‚Äî S√©curit√© : mouvement -> alarme (hors horaires)
    // =========================================================

    @GetMapping("isAutoSecurityActivated/")
    public ResponseEntity<String> isAutoSecurityActivated() {
        String title = "S√©curit√© Parking " + (autoSecurity ? "üîí‚úÖ" : "üîì‚ùå");
        String body  = autoSecurity
                ? "Surveillance activ√©e : si mouvement d√©tect√© hors horaires, l‚Äôalarme se d√©clenche."
                : "Surveillance d√©sactiv√©e : aucun d√©clenchement automatique d‚Äôalarme.";

        String extra = "<br/>Horaires autoris√©s : " + securityStart + " ‚Üí " + securityEnd +
                       "<br/>Actuellement : " + (isOutsideSecurityHours() ? "Hors horaires üåô" : "Dans horaires ‚òÄÔ∏è");

        logger.info(title);
        return new ResponseEntity<>(buildHtml(title, body + extra, "#3B0A0A", "#111827", "#FCA5A5"), HttpStatus.OK);
    }

    @GetMapping("setAutoSecurity/")
    public ResponseEntity<String> setAutoSecurity(@RequestParam boolean enabled) {
        autoSecurity = enabled;

        String title = "S√©curit√© - Mise √† jour " + (enabled ? "üîí‚úÖ" : "üîì‚ùå");
        String body  = enabled
                ? "Surveillance activ√©e : alarme d√©clench√©e en cas de mouvement hors horaires."
                : "Surveillance d√©sactiv√©e : alarme non pilot√©e automatiquement.";

        databaseLogger.logEvent("üîí AutoSecurity = " + enabled);
        logger.info(title);
        return new ResponseEntity<>(buildHtml(title, body, "#3B0A0A", "#111827", "#FCA5A5"), HttpStatus.OK);
    }

    @GetMapping("setSecurityHours/")
    public ResponseEntity<String> setSecurityHours(@RequestParam String start, @RequestParam String end) {
        // format attendu: HH:mm
        securityStart = LocalTime.parse(start);
        securityEnd   = LocalTime.parse(end);

        String title = "S√©curit√© - Horaires mis √† jour ‚è∞";
        String body  = "Nouveaux horaires autoris√©s : " + securityStart + " ‚Üí " + securityEnd +
                       "<br/>La surveillance d√©clenche l‚Äôalarme uniquement hors de cette plage.";

        databaseLogger.logEvent("‚è∞ SecurityHours = " + securityStart + " -> " + securityEnd);
        logger.info(title);
        return new ResponseEntity<>(buildHtml(title, body, "#3B0A0A", "#111827", "#FCA5A5"), HttpStatus.OK);
    }

    public void runAutoSecurity() {
        String url_getDetection = MovDetectUrl + "getDetection/";
        String url_setAlarmOn   = AlarmControlUrl + "setStatus/?oN=true";

        boolean movement = rt().getForObject(url_getDetection, boolean.class);

        if (!isOutsideSecurityHours()) {
            // Dans les horaires: on ne d√©clenche pas
            if (movement) {
                databaseLogger.logEvent("‚òÄÔ∏è Mouvement d√©tect√© MAIS dans les horaires : alarme non d√©clench√©e.");
            } else {
                databaseLogger.logEvent("‚òÄÔ∏è Aucun mouvement (dans horaires).");
            }
            return;
        }

        // Hors horaires
        if (movement) {
            rt().getForObject(url_setAlarmOn, Boolean.class);
            databaseLogger.logEvent("üö® INTRUSION : mouvement d√©tect√© hors horaires -> alarme d√©clench√©e.");
        } else {
            databaseLogger.logEvent("üåô Hors horaires : aucun mouvement, alarme inactive.");
        }
    }

    // =========================================================
    // SC√âNARIO 1 ‚Äî D√©tection voiture -> barri√®re open/close
    // =========================================================

    @GetMapping("isAutoBarrierActivated/")
    public ResponseEntity<String> isAutoBarrierActivated() {
        String title = "Acc√®s Parking - Barri√®re " + (autoBarrier ? "üöß‚úÖ" : "üöß‚ùå");
        String body  = autoBarrier
                ? "Mode automatique activ√© : la barri√®re s‚Äôouvre/ se ferme selon la d√©tection voiture."
                : "Mode automatique d√©sactiv√© : la barri√®re n‚Äôest pas pilot√©e automatiquement.";

        logger.info(title);
        return new ResponseEntity<>(buildHtml(title, body, "#0A2540", "#0B1220", "#93C5FD"), HttpStatus.OK);
    }

    @GetMapping("setAutoBarrier/")
    public ResponseEntity<String> setAutoBarrier(@RequestParam boolean enabled) {
        autoBarrier = enabled;

        String title = "Acc√®s Parking - Mise √† jour " + (enabled ? "üöó‚úÖ" : "üõë‚ùå");
        String body  = enabled
                ? "Mode automatique activ√© : d√©tection voiture -> commande barri√®re."
                : "Mode automatique d√©sactiv√© : barri√®re en manuel.";

        databaseLogger.logEvent("üöß AutoBarrier = " + enabled);
        logger.info(title);
        return new ResponseEntity<>(buildHtml(title, body, "#0A2540", "#0B1220", "#93C5FD"), HttpStatus.OK);
    }

    public void runAutoBarrier() {
        String url_getCar     = CarDetectUrl + "getDetection/";          // retourne boolean
        String url_open       = BarrierControlUrl + "open/";             // √† adapter
        String url_close      = BarrierControlUrl + "close/";            // √† adapter

        Boolean carDetected = rt().getForObject(url_getCar, Boolean.class);

        if (Boolean.TRUE.equals(carDetected)) {
            rt().getForObject(url_open, String.class);
            databaseLogger.logEvent("üöó Voiture d√©tect√©e -> barri√®re OUVERTE üÖøÔ∏è‚úÖ");
        } else {
            rt().getForObject(url_close, String.class);
            databaseLogger.logEvent("üöß Aucun v√©hicule -> barri√®re FERM√âE üîí");
        }
    }

    // =========================================================
    // Informations utiles : place parking occup√©e/libre
    // =========================================================

    @GetMapping("getParkingSpotStatus/")
    public ResponseEntity<String> getParkingSpotStatus() {
        // Ici on garde movement detection comme ‚Äúpr√©sence‚Äù (selon votre ancien projet)
        // Si vous avez un capteur voiture d√©di√©, remplace MovDetectUrl par CarDetectUrl.
        boolean occupied = rt().getForObject(MovDetectUrl + "getDetection/", boolean.class);

        String title = occupied ? "Place occup√©e üÖøÔ∏èüöó" : "Place libre üÖøÔ∏è‚úÖ";
        String body  = occupied
                ? "Un v√©hicule (ou une pr√©sence) est d√©tect√© sur la place."
                : "Aucune pr√©sence d√©tect√©e sur la place.";

        databaseLogger.logEvent("üÖøÔ∏è SpotStatus = " + (occupied ? "OCCUPIED" : "FREE"));
        logger.info(title);

        String bg = occupied ? "#3A2A00" : "#083B2E";
        String tc = occupied ? "#FBBF24" : "#86EFAC";

        return new ResponseEntity<>(buildHtml(title, body, bg, "#0B1220", tc), HttpStatus.OK);
    }

    // =========================================================
    // RUN GLOBAL : ex√©cute toutes les automatisations activ√©es
    // =========================================================

    @GetMapping("runAuto/")
    public ResponseEntity<String> runAuto() {
        StringBuilder actions = new StringBuilder();

        if (autoBarrier) {
            try {
                runAutoBarrier();
                actions.append("üöß Barri√®re : OK<br/>");
            } catch (Exception e) {
                actions.append("üöß Barri√®re : ERREUR (").append(e.getMessage()).append(")<br/>");
                logger.error("Erreur AutoBarrier", e);
            }
        }

        if (autoSecurity) {
            try {
                runAutoSecurity();
                actions.append("üîí S√©curit√© : OK<br/>");
            } catch (Exception e) {
                actions.append("üîí S√©curit√© : ERREUR (").append(e.getMessage()).append(")<br/>");
                logger.error("Erreur AutoSecurity", e);
            }
        }

        if (autoEnergyLight) {
            try {
                runAutoEnergyLight();
                actions.append("üí° √âclairage : OK<br/>");
            } catch (Exception e) {
                actions.append("üí° √âclairage : ERREUR (").append(e.getMessage()).append(")<br/>");
                logger.error("Erreur AutoEnergyLight", e);
            }
        }

        String title = "Ex√©cution des automatisations ‚öôÔ∏è‚úÖ";
        String body  = actions.length() == 0
                ? "Aucune automatisation activ√©e. Active au moins un mode (barri√®re/s√©curit√©/√©clairage)."
                : actions.toString();

        return new ResponseEntity<>(buildHtml(title, body, "#111827", "#0B1220", "#E5E7EB"), HttpStatus.OK);
    }

    public static void main(String[] args) {
        SpringApplication.run(ControllerApplication.class, args);
    }
}
